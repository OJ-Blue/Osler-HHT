<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Epistaxis Grading (IFT)</title>
  <meta name="description" content="IFT epistaxis severity calculator for HHT (Mb. Osler) over the past four weeks." />
  <link rel="icon" href="favicon.ico" />
  <style>
    :root{
      --bg:#2c3e50; /* page background */
      --card:#ffffff;
      --text:#111827; /* gray-900 */
      --muted:#475569; /* slate-600 */
      --brand:#2563eb; /* blue-600 */
      --brand-700:#1d4ed8;
      --ok:#16a34a; /* green-600 */
      --warn:#f59e0b; /* amber-500 */
      --bad:#ef4444; /* red-500 */
      --worse:#b91c1c; /* red-700 */
    }

    html,body{height:100%}
    body{margin:0; font-family: Arial, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans"; background: var(--bg); color:#ecf0f1; line-height:1.6; display:flex; align-items:flex-start; justify-content:center; padding:20px;}

    .wrap{ width: min(980px, 100%); }
    header{ text-align:center; margin-bottom:16px; }
    header h1{ margin:0; font-size:2.5rem; letter-spacing:.3px; }
    .sub{ color:#dbe2ea; margin-top:6px; font-size:1.1rem; }

    /* Toolbar: LEFT-aligned language buttons */
    .toolbar{ display:flex; justify-content:flex-start; gap:8px; flex-wrap:wrap; align-items:center; margin:16px 0; }
    .lang{ display:inline-flex; gap:6px; }
    .lang button{ appearance:none; border:none; background:#34495e; color:#fff; padding:8px 12px; border-radius:6px; cursor:pointer; font-weight:600; }
    .lang button:hover{ background:#2980b9; }
    .lang button[aria-pressed="true"]{ background:#1a5276; font-weight:700; }

    .card{ background:var(--card); color:var(--text); border-radius:14px; box-shadow: 0 12px 30px rgba(0,0,0,.25); padding:20px; }
    .section-title{ font-weight:700; color:var(--text); margin:2px 0 12px; }

    /* Clean, high-contrast help inside the white card */
    .help{ background:#eef2ff; border-left:4px solid #6366f1; color:#1f2937; padding:10px 12px; border-radius:8px; font-weight:600; margin-bottom:12px; }

    form{ display:grid; gap:16px; }
    fieldset{ border:none; margin:0; padding:0; background:#fff; border-radius:12px; }
    legend{ font-weight:700; margin-bottom:8px; color:#0f172a; }

    .options{ display:grid; gap:6px; margin-top:6px; }
    .radio{ display:flex; align-items:center; gap:10px; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; }
    .radio:hover{ border-color:#cbd5e1; }
    input[type="radio"]{ width:18px; height:18px; accent-color: var(--brand); }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }
    .btn{ appearance:none; border:none; background:var(--brand); color:#fff; font-weight:700; padding:12px 16px; border-radius:10px; cursor:pointer; }
    .btn:hover{ background:var(--brand-700); }
    .btn.secondary{ background:#0f172a; color:#e5e7eb; border:1px solid #1f2937; }

    .result{ margin-top:14px; display:grid; gap:10px; }
    .result .scoreline{ font-size:1.15rem; }
    .badge{ font-weight:800; padding:6px 10px; border-radius:999px; display:inline-block; }
    .mild{ color:var(--ok) }
    .moderate{ color:var(--warn) }
    .severe{ color:var(--bad) }
    .intractable{ color:var(--worse) }

    .scale{ margin-top:6px; }
    .bar{ position:relative; height:14px; border-radius:8px; background: linear-gradient(90deg, var(--ok) 0%, var(--warn) 40%, var(--bad) 70%, var(--worse) 100%); }
    .tick{ position:absolute; top:100%; transform:translateX(-50%); font-size:1.2rem; font-weight:700; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans"; color:#1f2937; margin-top:10px; }
    /* Arrow placed UNDER the bar, pointing UP */
    .marker{ position:absolute; top:100%; margin-top:6px; width:0; height:0; border-left:8px solid transparent; border-right:8px solid transparent; border-bottom:14px solid #111827; transform:translateX(-50%); filter: drop-shadow(0 1px 3px rgba(0,0,0,.4)); }

    .errors{ color:#b91c1c; font-weight:600; }

    details{ background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; padding:10px 12px; }
    /* Extra space so the arrow head never overlaps details */
    .result details{ margin-top:40px; }
    details > summary { cursor:pointer; font-weight:700; }

    footer{ text-align:center; color:#cbd5e1; font-size:.9rem; margin-top:18px; }
    footer a{ color:#cbd5e1; }

    @media (max-width:640px){ .radio{padding:10px} }
    @media print{ body{ background:#fff; color:#111 } .wrap{ width:100% } .toolbar{ display:none } .card{ box-shadow:none; border:1px solid #e5e7eb } footer{ color:#111 } }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 data-i18n="title">Epistaxis Grading (IFT)</h1>
      <p class="sub" data-i18n="subtitle">IFT measures the severity of nosebleeds in HHT over the past four weeks. Results can help guide treatment and follow‑up.</p>
    </header>

    <div class="toolbar" aria-label="controls">
      <div class="lang" role="group" aria-label="Language">
        <button type="button" id="lang-en" aria-pressed="true">English</button>
        <button type="button" id="lang-no" aria-pressed="false">Norsk</button>
      </div>
    </div>

    <main class="card" role="region" aria-labelledby="form-title">
      <h2 id="form-title" class="section-title" data-i18n="formTitle">Past 4 weeks</h2>
      <!-- Help text INSIDE the white card with good contrast -->
      <div class="help" data-i18n="hint">Answer each item. The score uses the two most severe intensities plus transfusion.</div>

      <form id="ift-form" novalidate>
        <template id="q-template">
          <fieldset class="q">
            <legend></legend>
            <div class="options"></div>
          </fieldset>
        </template>

        <div id="questions"></div>

        <fieldset class="q">
          <legend data-i18n="q5">5. In the past 4 weeks, have you needed a blood transfusion because of nosebleeds?</legend>
          <div class="options">
            <label class="radio"><input type="radio" name="transfusion" value="0"> <span data-i18n="no">No</span></label>
            <label class="radio"><input type="radio" name="transfusion" value="1"> <span data-i18n="yes">Yes</span></label>
            <label class="radio"><input type="radio" name="transfusion" value="2"> <span data-i18n="moreThanOnce">More than once</span></label>
          </div>
        </fieldset>

        <div class="actions">
          <button class="btn" type="submit" data-i18n="calc">Calculate score</button>
          <button class="btn secondary" type="button" id="btn-reset" data-i18n="reset">Reset</button>
        </div>
        <p id="form-errors" class="errors" role="alert" aria-live="polite"></p>
      </form>

      <section class="result" aria-live="polite" aria-atomic="true">
        <div class="scoreline" id="scoreline" hidden>
          <span class="badge" id="classBadge"></span>
          <span id="scoreText"></span>
        </div>
        <div class="scale" id="scale" hidden>
          <div class="bar" id="bar">
            <div class="marker" id="marker" style="left:0%"></div>
            <span class="tick" style="left:0%">0</span>
            <span class="tick" style="left:33.3%">10</span>
            <span class="tick" style="left:66.6%">20</span>
            <span class="tick" style="left:100%">30</span>
          </div>
        </div>
        <details id="details" hidden>
          <summary data-i18n="details">Show details</summary>
          <div id="explain"></div>
        </details>
      </section>
    </main>

    <footer>
      <p>The Intensity, Frequency, and Need for Blood Transfusion Score (IFT) was created by Sinan Dheyauldeen (Al‑Deen), M.D., PhD and Gregor Bachmann‑Harildstad, M.D., PhD. The online version was created by Ole Jakob Jørgensen, M.D.</p>
      <p>© 2024–2025</p>
      <p>This tool is for informational purposes only and should not replace professional medical consultation. Contact: <a href="mailto:oljoer@ous-hf.no">oljoer@ous-hf.no</a></p>
    </footer>
  </div>

  <script>
    // ---------- i18n strings ----------
    const I18N = {
      en: {
        title: 'Epistaxis Grading (IFT)',
        subtitle: 'IFT measures the severity of nosebleeds in HHT (Mb. Osler) over the past four weeks. Results can help guide treatment and follow‑up.',
        hint: 'Answer each item. The score uses the two most severe intensities plus transfusion.',
        formTitle: 'Past 4 weeks',
        q: [
          '1. In the past 4 weeks, how often have you noticed spots of blood or small drips?',
          '2. In the past 4 weeks, how often have you had a blood‑soaked handkerchief?',
          '3. In the past 4 weeks, how often have you had a blood‑soaked towel?',
          '4. In the past 4 weeks, how often have you had bleeding that fills as much as a bowl (½ liter)?'
        ],
        freq: ['None','1–5 times','6–10 times','11–27 times','Daily or more'],
        q5: '5. In the past 4 weeks, have you needed a blood transfusion because of nosebleeds?',
        yes: 'Yes', no: 'No', moreThanOnce:'More than once',
        calc:'Calculate score', reset:'Reset',
        details:'Show details',
        classes:['No bleeding','Mild bleeding','Moderate bleeding','Severe bleeding','Intractable bleeding'],
        scoreText:(s,max)=>`Your score: ${s}/${max}`,
        err:'Please answer at least one of the first four questions.'
      },
      no: {
        title: 'Epistaxis‑gradering (IFT)',
        subtitle: 'IFT måler alvorlighetsgrad av neseblødning ved HHT (Mb. Osler) de siste fire ukene. Resultatene kan veilede behandling og oppfølging.',
        hint: 'Svar på hvert punkt. Skåren bruker de to mest alvorlige intensiteter pluss transfusjon.',
        formTitle: 'Siste 4 uker',
        q: [
          '1. I løpet av de siste 4 ukene, hvor ofte har du merket blodflekker eller små dråper?',
          '2. I løpet av de siste 4 ukene, hvor ofte har du hatt et gjennomtrukket lommetørkle?',
          '3. I løpet av de siste 4 ukene, hvor ofte har du hatt et gjennomtrukket håndkle?',
          '4. I løpet av de siste 4 ukene, hvor ofte har du hatt blødning som fyller så mye som en bolle (½ liter)?'
        ],
        freq: ['Ingen','1–5 ganger','6–10 ganger','11–27 ganger','Daglig eller mer'],
        q5: '5. I løpet av de siste 4 ukene, har du trengt blodoverføring på grunn av neseblødning?',
        yes:'Ja', no:'Nei', moreThanOnce:'Flere ganger',
        calc:'Beregn skår', reset:'Nullstill',
        details:'Vis detaljer',
        classes:['Ingen blødning','Mild blødning','Moderat blødning','Alvorlig blødning','Ukontrollerbar blødning'],
        scoreText:(s,max)=>`Din skår: ${s}/${max}`,
        err:'Vennligst svar på minst ett av de fire første spørsmålene.'
      }
    };

    // ---------- Build questions ----------
    const questionsRoot = document.getElementById('questions');
    const qtpl = document.getElementById('q-template');
    const INTENSITY_WEIGHTS = [1,2,3,4];
    const FREQ_VALUES = [0,1,2,3,4]; // none..daily
    const MAX_TRANSFUSION = 2;

    function buildQuestions(current='en'){
      questionsRoot.innerHTML = '';
      I18N[current].q.forEach((label, idx)=>{
        const node = qtpl.content.cloneNode(true);
        const legend = node.querySelector('legend');
        const opts = node.querySelector('.options');
        const qname = `intensity${idx+1}`;
        legend.textContent = label;
        FREQ_VALUES.forEach((val,i)=>{
          const id = `${qname}-${val}`;
          const wrap = document.createElement('label');
          wrap.className = 'radio';
          wrap.innerHTML = `<input type=\"radio\" name=\"${qname}\" id=\"${id}\" value=\"${val}\"> <span>${I18N[current].freq[i]}</span>`;
          opts.appendChild(wrap);
        });
        questionsRoot.appendChild(node);
      });
    }

    // ---------- Language handling ----------
    const langBtns = { en: document.getElementById('lang-en'), no: document.getElementById('lang-no') };
    let lang = localStorage.getItem('ift-lang') || (navigator.language?.startsWith('no')?'no':'en');

    function applyLang(){
      document.documentElement.lang = lang;
      // Simple keys
      for (const key of ['title','subtitle','hint','formTitle','q5','calc','reset','details']){
        const nodes = document.querySelectorAll(`[data-i18n="${key}"]`);
        nodes.forEach(n=>{ n.textContent = I18N[lang][key]; });
      }
      // Transfusion options
      const tOpts = document.querySelectorAll('label.radio input[name="transfusion"]');
      if (tOpts.length === 3){
        tOpts[0].nextElementSibling.textContent = I18N[lang].no;
        tOpts[1].nextElementSibling.textContent = I18N[lang].yes;
        tOpts[2].nextElementSibling.textContent = I18N[lang].moreThanOnce;
      }
      document.title = I18N[lang].title;
      // Button states
      langBtns.en.setAttribute('aria-pressed', String(lang==='en'));
      langBtns.no.setAttribute('aria-pressed', String(lang==='no'));
    }

    function setLang(next){
      lang = next; localStorage.setItem('ift-lang', lang);
      buildQuestions(lang);
      applyLang();
      restoreFromStorage();
      bindActions();
    }

    langBtns.en.addEventListener('click',()=>setLang('en'));
    langBtns.no.addEventListener('click',()=>setLang('no'));

    // ---------- Scoring ----------
    function classify(score){
      if(score===0) return 0; // No bleeding
      if(score>=1 && score<=5) return 1;
      if(score>=6 && score<=10) return 2;
      if(score>=11 && score<=15) return 3;
      return 4; // >=16
    }

    function computeScore(frm){
      const answers = INTENSITY_WEIGHTS.map((w,i)=>{
        const rv = frm[`intensity${i+1}`]?.value; // '0'..'4' or undefined
        const freq = rv==null || rv==='' ? null : Number(rv);
        return { weight:w, freq, score: freq===null ? 0 : w*freq };
      });
      const tRaw = frm.transfusion?.value;
      const transfusion = tRaw==null || tRaw==='' ? 0 : Number(tRaw);
      const answeredAny = answers.some(a=>a.freq!==null);
      if(!answeredAny){ return { error: I18N[lang].err }; }
      const topTwo = answers.filter(a=>a.freq>0).sort((a,b)=>b.weight-a.weight).slice(0,2);
      const base = topTwo.reduce((sum,a)=>sum + a.score, 0);
      const total = base + transfusion;
      const max = INTENSITY_WEIGHTS.slice(-2).reduce((s,w)=>s+w*4,0) + MAX_TRANSFUSION; // 30
      return { total, max, breakdown:{answers, topTwo, transfusion} };
    }

    // ---------- Render result ----------
    const formEl = document.getElementById('ift-form');
    const scoreline = document.getElementById('scoreline');
    const classBadge = document.getElementById('classBadge');
    const scoreText = document.getElementById('scoreText');
    const marker = document.getElementById('marker');
    const scale = document.getElementById('scale');
    const details = document.getElementById('details');
    const explain = document.getElementById('explain');

    function renderResult(res){
      const errBox = document.getElementById('form-errors');
      if(res.error){ errBox.textContent = res.error; return; }
      errBox.textContent = '';
      const idx = classify(res.total);
      const labels = I18N[lang].classes;
      const classNames = ['mild','mild','moderate','severe','intractable'];
      classBadge.className = `badge ${classNames[idx]}`;
      classBadge.textContent = labels[idx];
      scoreText.textContent = (I18N[lang].scoreText)(res.total, res.max);
      scoreline.hidden = false;
      const pct = (res.total / res.max) * 100;
      marker.style.left = `${pct}%`; // precise; centered via translateX(-50%)
      scale.hidden = false;

      const list = document.createElement('ul');
      list.style.margin = '8px 0 0';
      list.style.paddingLeft = '18px';
      res.breakdown.topTwo.forEach(t=>{
        const li = document.createElement('li');
        li.textContent = `${I18N[lang].q[t.weight-1].replace(/^\d+\.\s?/,'')} → ${t.weight} × ${t.freq} = ${t.score}`;
        list.appendChild(li);
      });
      const liT = document.createElement('li');
      liT.textContent = `${I18N[lang].q5.replace(/^\d+\.\s?/,'')} → +${res.breakdown.transfusion}`;
      list.appendChild(liT);
      explain.innerHTML='';
      explain.appendChild(list);
      details.hidden = false;

      persistToStorage();
    }

    // ---------- Persistence ----------
    function persistToStorage(){
      const data = new FormData(formEl);
      const obj = {};
      for (const [k,v] of data.entries()) obj[k]=v;
      localStorage.setItem('ift-data', JSON.stringify({ lang, obj }));
    }
    function restoreFromStorage(){
      const raw = localStorage.getItem('ift-data');
      if(!raw) return; // first visit: keep empty
      try{
        const { obj } = JSON.parse(raw);
        if(!obj || Object.keys(obj).length === 0) return;
        for(const [k,v] of Object.entries(obj)){
          const input = formEl.querySelector(`[name="${k}"][value="${v}"]`);
          if(input) input.checked = true;
        }
      }catch{}
    }

    // ---------- Actions ----------
    function bindActions(){
      const resetBtn = document.getElementById('btn-reset');
      if(resetBtn){
        resetBtn.onclick = ()=>{
          if (typeof formEl.reset !== 'function') console.warn('form.reset unexpected');
          formEl.reset();
          localStorage.removeItem('ift-data');
          buildQuestions(lang);
          applyLang();
          bindActions();
          scoreline.hidden = true; scale.hidden = true; details.hidden = true;
          document.getElementById('form-errors').textContent = '';
        };
      }
    }

    // ---------- Form submit wiring ----------
    formEl.addEventListener('submit', (e)=>{
      e.preventDefault();
      const res = computeScore(formEl);
      renderResult(res);
    });

    // ---------- Init ----------
    // First-visit-per-session: ensure the form starts BLANK once per browser session
    try {
      if (!sessionStorage.getItem('ift-session-init')) {
        localStorage.removeItem('ift-data'); // clear old answers so nothing is prefilled
        sessionStorage.setItem('ift-session-init', '1');
      }
    } catch (e) { /* ignore storage errors */ }

    setLang(lang); // builds, applies language, restores (only if any remain), binds
  </script>
</body>
</html>
