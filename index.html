<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Epistaxis Grading (IFT)</title>
  <meta name="description" content="IFT epistaxis severity calculator for HHT over the past four weeks." />
  <link rel="icon" href="favicon.ico" />

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-JVL8QX2N93"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-JVL8QX2N93');
  </script>

  <style>
    :root{
      --bg:#2c3e50; /* page background */
      --card:#ffffff;
      --text:#111827; /* gray-900 */
      --muted:#475569; /* slate-600 */
      --brand:#2563eb; /* blue-600 */
      --brand-700:#1d4ed8;
      --ok:#16a34a; /* green-600 */
      --warn:#f59e0b; /* amber-500 */
      --bad:#ef4444; /* red-500 */
      --worse:#b91c1c; /* red-700 */
    }

    html,body{height:100%}
    body{
      margin:0;
      font-family: Arial, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans";
      background: var(--bg);
      color:#ecf0f1;
      line-height:1.6;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:20px;
    }

    .wrap{ width: min(980px, 100%); }
    header{ text-align:center; margin-bottom:16px; }
    header h1{ margin:0; font-size:2.5rem; letter-spacing:.3px; }
    .sub{ color:#dbe2ea; margin-top:6px; font-size:1.1rem; }

    /* Toolbar */
    .toolbar{
      display:flex;
      justify-content:flex-start;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      margin:16px 0;
    }
    .lang{
      display:inline-flex;
      gap:10px;
      align-items:center;
    }
    .lang label{
      font-weight:700;
      color:#dbe2ea;
    }
    .lang select{
      appearance:none;
      border:none;
      background:#34495e;
      color:#fff;
      padding:8px 12px;
      border-radius:6px;
      cursor:pointer;
      font-weight:700;
    }
    .lang select:hover{ background:#2980b9; }
    .lang select:focus{
      outline:2px solid rgba(255,255,255,.35);
      outline-offset:2px;
    }

    .card{
      background:var(--card);
      color:var(--text);
      border-radius:14px;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
      padding:20px;
    }
    .section-title{ font-weight:700; color:var(--text); margin:2px 0 12px; }

    /* Clean, high-contrast help inside the white card */
    .help{
      background:#eef2ff;
      border-left:4px solid #6366f1;
      color:#1f2937;
      padding:10px 12px;
      border-radius:8px;
      font-weight:600;
      margin-bottom:12px;
    }

    form{ display:grid; gap:16px; }
    fieldset{ border:none; margin:0; padding:0; background:#fff; border-radius:12px; }
    legend{ font-weight:700; margin-bottom:8px; color:#0f172a; }

    .options{ display:grid; gap:6px; margin-top:6px; }
    .radio{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border:1px solid #e5e7eb;
      border-radius:10px;
    }
    .radio:hover{ border-color:#cbd5e1; }
    input[type="radio"]{ width:18px; height:18px; accent-color: var(--brand); }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }
    .btn{
      appearance:none;
      border:none;
      background:var(--brand);
      color:#fff;
      font-weight:700;
      padding:12px 16px;
      border-radius:10px;
      cursor:pointer;
    }
    .btn:hover{ background:var(--brand-700); }
    .btn.secondary{ background:#0f172a; color:#e5e7eb; border:1px solid #1f2937; }

    .result{ margin-top:14px; display:grid; gap:10px; }
    .result .scoreline{ font-size:1.15rem; }
    .badge{
      font-weight:800;
      padding:6px 10px;
      border-radius:999px;
      display:inline-block;
    }
    .mild{ color:var(--ok) }
    .moderate{ color:var(--warn) }
    .severe{ color:var(--bad) }
    .intractable{ color:var(--worse) }

    .scale{ margin-top:6px; }
    .bar{
      position:relative;
      height:14px;
      border-radius:8px;
      background: linear-gradient(90deg, var(--ok) 0%, var(--warn) 40%, var(--bad) 70%, var(--worse) 100%);
    }
    .tick{
      position:absolute;
      top:100%;
      transform:translateX(-50%);
      font-size:1.2rem;
      font-weight:700;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans";
      color:#1f2937;
      margin-top:10px;
    }
    /* Arrow placed UNDER the bar, pointing UP */
    .marker{
      position:absolute;
      top:100%;
      margin-top:6px;
      width:0;
      height:0;
      border-left:8px solid transparent;
      border-right:8px solid transparent;
      border-bottom:14px solid #111827;
      transform:translateX(-50%);
      filter: drop-shadow(0 1px 3px rgba(0,0,0,.4));
    }

    .errors{ color:#b91c1c; font-weight:600; }

    details{
      background:#f8fafc;
      border:1px solid #e2e8f0;
      border-radius:10px;
      padding:10px 12px;
    }
    /* Extra space so the arrow head never overlaps details */
    .result details{ margin-top:40px; }
    details > summary { cursor:pointer; font-weight:700; }

    footer{ text-align:center; color:#cbd5e1; font-size:.9rem; margin-top:18px; }
    footer a{ color:#cbd5e1; }
    #footer-note{ margin-top:10px; }

    @media (max-width:640px){ .radio{padding:10px} }
    @media print{
      body{ background:#fff; color:#111 }
      .wrap{ width:100% }
      .toolbar{ display:none }
      .card{ box-shadow:none; border:1px solid #e5e7eb }
      footer{ color:#111 }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 data-i18n="title">Epistaxis Grading (IFT)</h1>
      <p class="sub" data-i18n="subtitle">IFT measures the severity of nosebleeds in HHT over the past four weeks. Results can help guide treatment and follow-up.</p>
    </header>

    <div class="toolbar" aria-label="controls">
      <div class="lang" role="group" aria-label="Language">
        <label for="lang-select">Language</label>
        <select id="lang-select" aria-label="Language">
          <option value="en">English</option>
          <option value="no">Norsk</option>
          <option value="zh-CN">中文（简体）</option>
          <option value="ja">日本語</option>
          <option value="es">Español</option>
          <option value="fr">Français</option>
          <option value="it">Italiano</option>
        </select>
      </div>
    </div>

    <main class="card" role="region" aria-labelledby="form-title">
      <h2 id="form-title" class="section-title" data-i18n="formTitle">Past 4 weeks</h2>
      <div class="help" data-i18n="hint">Answer each item. The score uses the two most severe intensities plus transfusion.</div>

      <form id="ift-form" novalidate>
        <template id="q-template">
          <fieldset class="q">
            <legend></legend>
            <div class="options"></div>
          </fieldset>
        </template>

        <div id="questions"></div>

        <fieldset class="q">
          <legend data-i18n="q5">5. In the past 4 weeks, have you needed a blood transfusion because of nosebleeds?</legend>
          <div class="options">
            <label class="radio"><input type="radio" name="transfusion" value="0"> <span data-i18n="no">No</span></label>
            <label class="radio"><input type="radio" name="transfusion" value="1"> <span data-i18n="yes">Yes</span></label>
            <label class="radio"><input type="radio" name="transfusion" value="2"> <span data-i18n="moreThanOnce">More than once</span></label>
          </div>
        </fieldset>

        <div class="actions">
          <button class="btn" type="submit" data-i18n="calc">Calculate score</button>
          <button class="btn secondary" type="button" id="btn-reset" data-i18n="reset">Reset</button>
        </div>
        <p id="form-errors" class="errors" role="alert" aria-live="polite"></p>
      </form>

      <section class="result" aria-live="polite" aria-atomic="true">
        <div class="scoreline" id="scoreline" hidden>
          <span class="badge" id="classBadge"></span>
          <span id="scoreText"></span>
        </div>
        <div class="scale" id="scale" hidden>
          <div class="bar" id="bar">
            <div class="marker" id="marker" style="left:0%"></div>
            <span class="tick" style="left:0%">0</span>
            <span class="tick" style="left:33.3%">10</span>
            <span class="tick" style="left:66.6%">20</span>
            <span class="tick" style="left:100%">30</span>
          </div>
        </div>
        <details id="details" hidden>
          <summary data-i18n="details">Show details</summary>
          <div id="explain"></div>
        </details>
      </section>
    </main>

    <footer>
      <p>The Intensity, Frequency, and Need for Blood Transfusion Score (IFT) was created by Sinan Dheyauldeen (Al-Deen), M.D., PhD and Gregor Bachmann-Harildstad, M.D., PhD. The online version was created by Ole Jakob Jørgensen, M.D.</p>
      <p id="footer-note"></p>
      <p>© 2024–2025</p>
      <p>This tool is for informational purposes only and should not replace professional medical consultation. Contact: <a href="mailto:oljoer@ous-hf.no">oljoer@ous-hf.no</a></p>
    </footer>
  </div>

  <script>
    // ---------- i18n strings ----------
    const I18N = {
      en: {
        title: 'Epistaxis Grading (IFT)',
        subtitle: 'IFT measures the severity of nosebleeds in HHT (Mb. Osler) over the past four weeks. Results can help guide treatment and follow-up.',
        hint: 'Answer each item. The score uses the two most severe intensities plus transfusion.',
        formTitle: 'Past 4 weeks',
        q: [
          '1. In the past 4 weeks, how often have you noticed spots of blood or small drips?',
          '2. In the past 4 weeks, how often have you had a blood-soaked handkerchief?',
          '3. In the past 4 weeks, how often have you had a blood-soaked towel?',
          '4. In the past 4 weeks, how often have you had bleeding that fills as much as a bowl (½ liter)?'
        ],
        freq: ['None','1–5 times','6–10 times','11–27 times','Daily or more'],
        q5: '5. In the past 4 weeks, have you needed a blood transfusion because of nosebleeds?',
        yes: 'Yes', no: 'No', moreThanOnce:'More than once',
        calc:'Calculate score', reset:'Reset',
        details:'Show details',
        classes:['No bleeding','Mild bleeding','Moderate bleeding','Severe bleeding','Intractable bleeding'],
        scoreText:(s,max)=>`Your score: ${s}/${max}`,
        err:'Please answer at least one of the first four questions.',
        footerNote:'Translations are provided for accessibility. The IFT has not yet been formally validated in all available languages. If discrepancies arise, the English version is authoritative.'
      },
      no: {
        title: 'Epistaxis-gradering (IFT)',
        subtitle: 'IFT måler alvorlighetsgrad av neseblødning ved HHT de siste fire ukene. Resultatene kan veilede behandling og oppfølging.',
        hint: 'Svar på hvert punkt. Skåren bruker de to mest alvorlige intensiteter pluss transfusjon.',
        formTitle: 'Siste 4 uker',
        q: [
          '1. I løpet av de siste 4 ukene, hvor ofte har du merket blodflekker eller små dråper?',
          '2. I løpet av de siste 4 ukene, hvor ofte har du hatt et gjennomtrukket lommetørkle?',
          '3. I løpet av de siste 4 ukene, hvor ofte har du hatt et gjennomtrukket håndkle?',
          '4. I løpet av de siste 4 ukene, hvor ofte har du hatt blødning som fyller så mye som en bolle (½ liter)?'
        ],
        freq: ['Ingen','1–5 ganger','6–10 ganger','11–27 ganger','Daglig eller mer'],
        q5: '5. I løpet av de siste 4 ukene, har du trengt blodoverføring på grunn av neseblødning?',
        yes:'Ja', no:'Nei', moreThanOnce:'Flere ganger',
        calc:'Beregn skår', reset:'Nullstill',
        details:'Vis detaljer',
        classes:['Ingen blødning','Mild blødning','Moderat blødning','Alvorlig blødning','Ukontrollerbar blødning'],
        scoreText:(s,max)=>`Din skår: ${s}/${max}`,
        err:'Vennligst svar på minst ett av de fire første spørsmålene.',
        footerNote:'Oversettelser tilbys for tilgjengelighet. IFT er ikke formelt validert på alle tilgjengelige språk. Ved eventuelle avvik er den engelske versjonen autoritativ.'
      },
      'zh-CN': {
        title: '鼻出血分级（IFT）',
        subtitle: 'IFT 用于评估过去四周内 HHT（遗传性出血性毛细血管扩张症）患者鼻出血的严重程度。结果可用于指导治疗和随访。',
        hint: '请回答每一项。总分由最严重的两种出血强度加上是否需要输血计算得出。',
        formTitle: '过去 4 周',
        q: [
          '1. 在过去 4 周内，您注意到血迹或少量滴血的频率是多少？',
          '2. 在过去 4 周内，您有多少次手帕被血完全浸透？',
          '3. 在过去 4 周内，您有多少次毛巾被血完全浸透？',
          '4. 在过去 4 周内，您有多少次出血量达到可装满一个碗（约 0.5 升）？'
        ],
        freq: ['无','1–5 次','6–10 次','11–27 次','每天或更频繁'],
        q5: '5. 在过去 4 周内，您是否因鼻出血而需要输血？',
        yes:'是', no:'否', moreThanOnce:'多于一次',
        calc:'计算评分', reset:'重置',
        details:'显示详情',
        classes:['无出血','轻度出血','中度出血','重度出血','难治性出血'],
        scoreText:(s,max)=>`您的评分：${s}/${max}`,
        err:'请至少回答前四个问题中的一个。',
        footerNote:'提供翻译以提高可访问性。IFT 尚未在所有可用语言中经过正式验证。如有差异，以英文版本为准。'
      },
      ja: {
        title: '鼻出血重症度評価（IFT）',
        subtitle: 'IFT は、過去 4 週間における HHT の鼻出血の重症度を評価します。結果は治療および経過観察の参考となります。',
        hint: '各項目に回答してください。スコアは最も重度な 2 つの出血強度と輸血の有無を加えて算出されます。',
        formTitle: '過去 4 週間',
        q: [
          '1. 過去 4 週間で、血の斑点や少量の滴下に気づいた頻度はどのくらいですか？',
          '2. 過去 4 週間で、ハンカチが血で完全に染み込んだことはどのくらいありましたか？',
          '3. 過去 4 週間で、タオルが血で完全に染み込んだことはどのくらいありましたか？',
          '4. 過去 4 週間で、容器（約 0.5 リットル）を満たすほどの出血はどのくらいありましたか？'
        ],
        freq: ['なし','1～5 回','6～10 回','11～27 回','毎日またはそれ以上'],
        q5: '5. 過去 4 週間で、鼻出血のために輸血が必要でしたか？',
        yes:'はい', no:'いいえ', moreThanOnce:'複数回',
        calc:'スコアを計算', reset:'リセット',
        details:'詳細を表示',
        classes:['出血なし','軽度の出血','中等度の出血','重度の出血','難治性出血'],
        scoreText:(s,max)=>`あなたのスコア：${s}/${max}`,
        err:'最初の 4 問のうち少なくとも 1 問に回答してください。',
        footerNote:'翻訳はアクセシビリティ向上のために提供されています。IFT はすべての言語で正式に検証されているわけではありません。不一致がある場合は英語版が基準となります。'
      },
      es: {
        title: 'Clasificación de epistaxis (IFT)',
        subtitle: 'IFT evalúa la gravedad de las hemorragias nasales en la HHT durante las últimas cuatro semanas. Los resultados pueden ayudar a orientar el tratamiento y el seguimiento.',
        hint: 'Responda cada pregunta. La puntuación se basa en las dos intensidades más graves más la transfusión.',
        formTitle: 'Últimas 4 semanas',
        q: [
          '1. En las últimas 4 semanas, ¿con qué frecuencia ha notado manchas de sangre o pequeños goteos?',
          '2. En las últimas 4 semanas, ¿con qué frecuencia un pañuelo estuvo completamente empapado de sangre?',
          '3. En las últimas 4 semanas, ¿con qué frecuencia una toalla estuvo completamente empapada de sangre?',
          '4. En las últimas 4 semanas, ¿con qué frecuencia el sangrado llenó un recipiente (aprox. 0,5 litros)?'
        ],
        freq: ['Ninguna','1–5 veces','6–10 veces','11–27 veces','A diario o más'],
        q5: '5. En las últimas 4 semanas, ¿ha necesitado una transfusión de sangre debido a epistaxis?',
        yes:'Sí', no:'No', moreThanOnce:'Más de una vez',
        calc:'Calcular puntuación', reset:'Restablecer',
        details:'Mostrar detalles',
        classes:['Sin sangrado','Sangrado leve','Sangrado moderado','Sangrado grave','Sangrado intratable'],
        scoreText:(s,max)=>`Su puntuación: ${s}/${max}`,
        err:'Responda al menos una de las primeras cuatro preguntas.',
        footerNote:'Las traducciones se proporcionan para mejorar la accesibilidad. El IFT no ha sido validado formalmente en todos los idiomas disponibles. En caso de discrepancias, la versión en inglés es la referencia.'
      },
      fr: {
        title: 'Classification des épistaxis (IFT)',
        subtitle: 'L’IFT mesure la sévérité des saignements de nez dans la HHT au cours des quatre dernières semaines. Les résultats peuvent aider à guider le traitement et le suivi.',
        hint: 'Veuillez répondre à chaque question. Le score repose sur les deux intensités les plus sévères plus la transfusion.',
        formTitle: 'Quatre dernières semaines',
        q: [
          '1. Au cours des 4 dernières semaines, à quelle fréquence avez-vous remarqué des taches de sang ou de petites gouttes ?',
          '2. Au cours des 4 dernières semaines, à quelle fréquence un mouchoir a-t-il été complètement imbibé de sang ?',
          '3. Au cours des 4 dernières semaines, à quelle fréquence une serviette a-t-elle été complètement imbibée de sang ?',
          '4. Au cours des 4 dernières semaines, à quelle fréquence le saignement a-t-il rempli un récipient (environ 0,5 litre) ?'
        ],
        freq: ['Aucune','1–5 fois','6–10 fois','11–27 fois','Tous les jours ou plus'],
        q5: '5. Au cours des 4 dernières semaines, avez-vous eu besoin d’une transfusion sanguine en raison d’épistaxis ?',
        yes:'Oui', no:'Non', moreThanOnce:'Plus d’une fois',
        calc:'Calculer le score', reset:'Réinitialiser',
        details:'Afficher les détails',
        classes:['Aucun saignement','Saignement léger','Saignement modéré','Saignement sévère','Saignement incontrôlable'],
        scoreText:(s,max)=>`Votre score : ${s}/${max}`,
        err:'Veuillez répondre à au moins une des quatre premières questions.',
        footerNote:'Les traductions sont fournies à des fins d’accessibilité. L’IFT n’a pas encore été validé formellement dans toutes les langues disponibles. En cas de divergence, la version anglaise fait autorité.'
      },
      it: {
        title: 'Classificazione dell’epistassi (IFT)',
        subtitle: 'L’IFT misura la gravità dell’epistassi nella HHT nelle ultime quattro settimane. I risultati possono aiutare a orientare il trattamento e il follow-up.',
        hint: 'Rispondere a ogni domanda. Il punteggio si basa sulle due intensità più gravi più la trasfusione.',
        formTitle: 'Ultime 4 settimane',
        q: [
          '1. Nelle ultime 4 settimane, con quale frequenza ha notato macchie di sangue o piccoli gocciolamenti?',
          '2. Nelle ultime 4 settimane, con quale frequenza un fazzoletto è stato completamente impregnato di sangue?',
          '3. Nelle ultime 4 settimane, con quale frequenza un asciugamano è stato completamente impregnato di sangue?',
          '4. Nelle ultime 4 settimane, con quale frequenza il sanguinamento ha riempito un recipiente (circa 0,5 litri)?'
        ],
        freq: ['Nessuna','1–5 volte','6–10 volte','11–27 volte','Ogni giorno o più'],
        q5: '5. Nelle ultime 4 settimane, ha avuto bisogno di una trasfusione di sangue a causa dell’epistassi?',
        yes:'Sì', no:'No', moreThanOnce:'Più di una volta',
        calc:'Calcola punteggio', reset:'Reimposta',
        details:'Mostra dettagli',
        classes:['Nessun sanguinamento','Sanguinamento lieve','Sanguinamento moderato','Sanguinamento grave','Sanguinamento intrattabile'],
        scoreText:(s,max)=>`Il tuo punteggio: ${s}/${max}`,
        err:'Rispondere ad almeno una delle prime quattro domande.',
        footerNote:'Le traduzioni sono fornite per migliorare l’accessibilità. L’IFT non è stato formalmente validato in tutte le lingue disponibili. In caso di discrepanze, la versione inglese è quella di riferimento.'
      }
    };

    // ---------- Build questions ----------
    const questionsRoot = document.getElementById('questions');
    const qtpl = document.getElementById('q-template');
    const INTENSITY_WEIGHTS = [1,2,3,4];
    const FREQ_VALUES = [0,1,2,3,4]; // none..daily
    const MAX_TRANSFUSION = 2;

    function buildQuestions(current='en'){
      questionsRoot.innerHTML = '';
      I18N[current].q.forEach((label, idx)=>{
        const node = qtpl.content.cloneNode(true);
        const legend = node.querySelector('legend');
        const opts = node.querySelector('.options');
        const qname = `intensity${idx+1}`;
        legend.textContent = label;
        FREQ_VALUES.forEach((val,i)=>{
          const id = `${qname}-${val}`;
          const wrap = document.createElement('label');
          wrap.className = 'radio';
          wrap.innerHTML = `<input type="radio" name="${qname}" id="${id}" value="${val}"> <span>${I18N[current].freq[i]}</span>`;
          opts.appendChild(wrap);
        });
        questionsRoot.appendChild(node);
      });
    }

    // ---------- Language handling ----------
    const langSelect = document.getElementById('lang-select');

    // Option B with "English on first-ever visit":
    // - if no saved language exists, start with English
    // - otherwise restore last selected language
    let lang = (function(){
      const saved = localStorage.getItem('ift-lang');
      return (saved && I18N[saved]) ? saved : 'en';
    })();

    function applyLang(){
      document.documentElement.lang = lang;

      // Simple keys
      for (const key of ['title','subtitle','hint','formTitle','q5','calc','reset','details']){
        const nodes = document.querySelectorAll(`[data-i18n="${key}"]`);
        nodes.forEach(n=>{ n.textContent = I18N[lang][key]; });
      }

      // Transfusion options
      const tOpts = document.querySelectorAll('label.radio input[name="transfusion"]');
      if (tOpts.length === 3){
        tOpts[0].nextElementSibling.textContent = I18N[lang].no;
        tOpts[1].nextElementSibling.textContent = I18N[lang].yes;
        tOpts[2].nextElementSibling.textContent = I18N[lang].moreThanOnce;
      }

      // Footer disclaimer (activated)
      document.getElementById('footer-note').textContent = I18N[lang].footerNote;

      document.title = I18N[lang].title;
    }

    function setLang(next){
      if(!I18N[next]) next = 'en';
      lang = next;

      // Persist language for next visit
      try { localStorage.setItem('ift-lang', lang); } catch (e) {}

      langSelect.value = lang;

      buildQuestions(lang);
      applyLang();
      restoreFromStorage();
      bindActions();
    }

    langSelect.addEventListener('change', ()=>{
      setLang(langSelect.value);
    });

    // ---------- Scoring ----------
    function classify(score){
      if(score===0) return 0; // No bleeding
      if(score>=1 && score<=5) return 1;
      if(score>=6 && score<=10) return 2;
      if(score>=11 && score<=15) return 3;
      return 4; // >=16
    }

    function computeScore(frm){
      const answers = INTENSITY_WEIGHTS.map((w,i)=>{
        const rv = frm[`intensity${i+1}`]?.value; // '0'..'4' or undefined
        const freq = rv==null || rv==='' ? null : Number(rv);
        return { weight:w, freq, score: freq===null ? 0 : w*freq };
      });
      const tRaw = frm.transfusion?.value;
      const transfusion = tRaw==null || tRaw==='' ? 0 : Number(tRaw);
      const answeredAny = answers.some(a=>a.freq!==null);
      if(!answeredAny){ return { error: I18N[lang].err }; }
      const topTwo = answers.filter(a=>a.freq>0).sort((a,b)=>b.weight-a.weight).slice(0,2);
      const base = topTwo.reduce((sum,a)=>sum + a.score, 0);
      const total = base + transfusion;
      const max = INTENSITY_WEIGHTS.slice(-2).reduce((s,w)=>s+w*4,0) + MAX_TRANSFUSION; // 30
      return { total, max, breakdown:{answers, topTwo, transfusion} };
    }

    // ---------- Render result ----------
    const formEl = document.getElementById('ift-form');
    const scoreline = document.getElementById('scoreline');
    const classBadge = document.getElementById('classBadge');
    const scoreText = document.getElementById('scoreText');
    const marker = document.getElementById('marker');
    const scale = document.getElementById('scale');
    const details = document.getElementById('details');
    const explain = document.getElementById('explain');

    function renderResult(res){
      const errBox = document.getElementById('form-errors');
      if(res.error){ errBox.textContent = res.error; return; }
      errBox.textContent = '';
      const idx = classify(res.total);
      const labels = I18N[lang].classes;
      const classNames = ['mild','mild','moderate','severe','intractable'];
      classBadge.className = `badge ${classNames[idx]}`;
      classBadge.textContent = labels[idx];
      scoreText.textContent = (I18N[lang].scoreText)(res.total, res.max);
      scoreline.hidden = false;
      const pct = (res.total / res.max) * 100;
      marker.style.left = `${pct}%`; // precise; centered via translateX(-50%)
      scale.hidden = false;

      const list = document.createElement('ul');
      list.style.margin = '8px 0 0';
      list.style.paddingLeft = '18px';
      res.breakdown.topTwo.forEach(t=>{
        const li = document.createElement('li');
        li.textContent = `${I18N[lang].q[t.weight-1].replace(/^\d+\.\s?/,'')} → ${t.weight} × ${t.freq} = ${t.score}`;
        list.appendChild(li);
      });
      const liT = document.createElement('li');
      liT.textContent = `${I18N[lang].q5.replace(/^\d+\.\s?/,'')} → +${res.breakdown.transfusion}`;
      list.appendChild(liT);
      explain.innerHTML='';
      explain.appendChild(list);
      details.hidden = false;

      persistToStorage();
    }

    // ---------- Persistence ----------
    function persistToStorage(){
      const data = new FormData(formEl);
      const obj = {};
      for (const [k,v] of data.entries()) obj[k]=v;
      localStorage.setItem('ift-data', JSON.stringify({ lang, obj }));
    }
    function restoreFromStorage(){
      const raw = localStorage.getItem('ift-data');
      if(!raw) return;
      try{
        const parsed = JSON.parse(raw);
        const obj = parsed?.obj;
        if(!obj || Object.keys(obj).length === 0) return;
        for(const [k,v] of Object.entries(obj)){
          const input = formEl.querySelector(`[name="${k}"][value="${v}"]`);
          if(input) input.checked = true;
        }
      }catch{}
    }

    // ---------- Actions ----------
    function bindActions(){
      const resetBtn = document.getElementById('btn-reset');
      if(resetBtn){
        resetBtn.onclick = ()=>{
          if (typeof formEl.reset !== 'function') console.warn('form.reset unexpected');
          formEl.reset();
          localStorage.removeItem('ift-data');
          buildQuestions(lang);
          applyLang();
          bindActions();
          scoreline.hidden = true; scale.hidden = true; details.hidden = true;
          document.getElementById('form-errors').textContent = '';
        };
      }
    }

    // ---------- Form submit wiring ----------
    formEl.addEventListener('submit', (e)=>{
      e.preventDefault();
      const res = computeScore(formEl);
      renderResult(res);
    });

    // ---------- Init ----------
    // First-visit-per-session: ensure the form starts BLANK once per browser session
    try {
      if (!sessionStorage.getItem('ift-session-init')) {
        localStorage.removeItem('ift-data'); // clear old answers so nothing is prefilled
        sessionStorage.setItem('ift-session-init', '1');
      }
    } catch (e) { /* ignore storage errors */ }

    // Apply initial language (English on first-ever visit; otherwise last selected)
    setLang(lang);
  </script>
</body>
</html>
