
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Epistaxis Grading (IFT)</title>
  <meta name="description" content="IFT epistaxis severity calculator for HHT over the past four weeks." />
  <link rel="icon" href="favicon.ico" />

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-JVL8QX2N93"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-JVL8QX2N93');
  </script>

  <style>
    :root{
      --bg:#2c3e50; /* page background */
      --card:#ffffff;
      --text:#111827; /* gray-900 */
      --muted:#475569; /* slate-600 */
      --brand:#2563eb; /* blue-600 */
      --brand-700:#1d4ed8;
      --ok:#16a34a; /* green-600 */
      --warn:#f59e0b; /* amber-500 */
      --bad:#ef4444; /* red-500 */
      --worse:#b91c1c; /* red-700 */
    }

    html,body{height:100%}
    body{
      margin:0;
      font-family: Arial, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans";
      background: var(--bg);
      color:#ecf0f1;
      line-height:1.6;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:20px;
    }

    .wrap{ width: min(980px, 100%); }
    header{ text-align:center; margin-bottom:16px; }
    header h1{ margin:0; font-size:2.5rem; letter-spacing:.3px; }
    .sub{ color:#dbe2ea; margin-top:6px; font-size:1.1rem; }

    /* Toolbar */
    .toolbar{
      display:flex;
      justify-content:flex-start;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      margin:16px 0;
    }
    .lang{
      display:inline-flex;
      gap:10px;
      align-items:center;
    }
    .lang label{
      font-weight:700;
      color:#dbe2ea;
    }
    .lang select{
      appearance:none;
      border:none;
      background:#34495e;
      color:#fff;
      padding:8px 12px;
      border-radius:6px;
      cursor:pointer;
      font-weight:700;
    }
    .lang select:hover{ background:#2980b9; }
    .lang select:focus{
      outline:2px solid rgba(255,255,255,.35);
      outline-offset:2px;
    }

    .card{
      background:var(--card);
      color:var(--text);
      border-radius:14px;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
      padding:20px;
    }
    .section-title{ font-weight:700; color:var(--text); margin:2px 0 12px; }

    /* Clean, high-contrast help inside the white card */
    .help{
      background:#eef2ff;
      border-left:4px solid #6366f1;
      color:#1f2937;
      padding:10px 12px;
      border-radius:8px;
      font-weight:600;
      margin-bottom:12px;
    }

    form{ display:grid; gap:16px; }
    fieldset{ border:none; margin:0; padding:0; background:#fff; border-radius:12px; }
    legend{ font-weight:700; margin-bottom:8px; color:#0f172a; }

    .options{ display:grid; gap:6px; margin-top:6px; }
    .radio{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border:1px solid #e5e7eb;
      border-radius:10px;
    }
    .radio:hover{ border-color:#cbd5e1; }
    input[type="radio"]{ width:18px; height:18px; accent-color: var(--brand); }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }
    .btn{
      appearance:none;
      border:none;
      background:var(--brand);
      color:#fff;
      font-weight:700;
      padding:12px 16px;
      border-radius:10px;
      cursor:pointer;
    }
    .btn:hover{ background:var(--brand-700); }
    .btn.secondary{ background:#0f172a; color:#e5e7eb; border:1px solid #1f2937; }

    .result{ margin-top:14px; display:grid; gap:10px; }
    .result .scoreline{ font-size:1.15rem; }
    .badge{
      font-weight:800;
      padding:6px 10px;
      border-radius:999px;
      display:inline-block;
    }
    .mild{ color:var(--ok) }
    .moderate{ color:var(--warn) }
    .severe{ color:var(--bad) }
    .intractable{ color:var(--worse) }

    .scale{ margin-top:6px; }
    .bar{
      position:relative;
      height:14px;
      border-radius:8px;
      background: linear-gradient(90deg, var(--ok) 0%, var(--warn) 40%, var(--bad) 70%, var(--worse) 100%);
    }
    .tick{
      position:absolute;
      top:100%;
      transform:translateX(-50%);
      font-size:1.2rem;
      font-weight:700;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans";
      color:#1f2937;
      margin-top:10px;
    }
    /* Arrow placed UNDER the bar, pointing UP */
    .marker{
      position:absolute;
      top:100%;
      margin-top:6px;
      width:0;
      height:0;
      border-left:8px solid transparent;
      border-right:8px solid transparent;
      border-bottom:14px solid #111827;
      transform:translateX(-50%);
      filter: drop-shadow(0 1px 3px rgba(0,0,0,.4));
    }

    .errors{ color:#b91c1c; font-weight:600; }

    details{
      background:#f8fafc;
      border:1px solid #e2e8f0;
      border-radius:10px;
      padding:10px 12px;
    }
    /* Extra space so the arrow head never overlaps details */
    .result details{ margin-top:40px; }
    details > summary { cursor:pointer; font-weight:700; }

    footer{ text-align:center; color:#cbd5e1; font-size:.9rem; margin-top:18px; }
    footer a{ color:#cbd5e1; }
    #footer-note{ margin-top:10px; }

    @media (max-width:640px){ .radio{padding:10px} }
    @media print{
      body{ background:#fff; color:#111 }
      .wrap{ width:100% }
      .toolbar{ display:none }
      .card{ box-shadow:none; border:1px solid #e5e7eb }
      footer{ color:#111 }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 data-i18n="title">Epistaxis Grading (IFT)</h1>
      <p class="sub" data-i18n="subtitle">IFT measures the severity of nosebleeds in hereditary hemorrhagic telangiectasia (HHT) over the past four weeks. Results may help guide treatment and follow-up.</p>
    </header>

    <div class="toolbar" aria-label="controls">
      <div class="lang" role="group" aria-label="Language">
        <label for="lang-select">Language</label>
        <select id="lang-select" aria-label="Language">
          <option value="en">English</option>
          <option value="no">Norsk</option>
          <option value="zh-CN">中文（简体）</option>
          <option value="ja">日本語</option>
          <option value="es">Español</option>
          <option value="fr">Français</option>
          <option value="it">Italiano</option>
        </select>
      </div>
    </div>

    <main class="card" role="region" aria-labelledby="form-title">
      <h2 id="form-title" class="section-title" data-i18n="formTitle">Over the past 4 weeks</h2>
      <div class="help" data-i18n="hint">Please answer each question. The score uses the two most frequent bleeding intensities, plus the transfusion item.</div>

      <form id="ift-form" novalidate>
        <template id="q-template">
          <fieldset class="q">
            <legend></legend>
            <div class="options"></div>
          </fieldset>
        </template>

        <div id="questions"></div>

        <fieldset class="q">
          <legend data-i18n="q5">Over the past 4 weeks, how many times did you receive a blood transfusion?</legend>
          <div class="options">
            <label class="radio"><input type="radio" name="transfusion" value="0"> <span data-i18n="tNone">None</span></label>
            <label class="radio"><input type="radio" name="transfusion" value="1"> <span data-i18n="tOnce">Once</span></label>
            <label class="radio"><input type="radio" name="transfusion" value="2"> <span data-i18n="tMoreThanOnce">More than once</span></label>
          </div>
        </fieldset>

        <div class="actions">
          <button class="btn" type="submit" data-i18n="calc">Calculate the score</button>
          <button class="btn secondary" type="button" id="btn-reset" data-i18n="reset">Reset</button>
        </div>
        <p id="form-errors" class="errors" role="alert" aria-live="polite"></p>
      </form>

      <section class="result" aria-live="polite" aria-atomic="true">
        <div class="scoreline" id="scoreline" hidden>
          <span class="badge" id="classBadge"></span>
          <span id="scoreText"></span>
        </div>
        <div class="scale" id="scale" hidden>
          <div class="bar" id="bar">
            <div class="marker" id="marker" style="left:0%"></div>
            <span class="tick" style="left:0%">0</span>
            <span class="tick" style="left:33.3%">10</span>
            <span class="tick" style="left:66.6%">20</span>
            <span class="tick" style="left:100%">30</span>
          </div>
        </div>
        <details id="details" hidden>
          <summary data-i18n="details">Show details</summary>
          <div id="explain"></div>
        </details>
      </section>
    </main>

    <footer>
      <p>The Intensity, Frequency, and Need for Blood Transfusion Score (IFT) was developed by Sinan Dheyauldeen (Al-Deen), MD, PhD, and Gregor Bachmann-Harildstad, MD, PhD. This online calculator was implemented by Ole Jakob Jørgensen, MD.</p>
      <p id="footer-note"></p>
      <p>© 2025–2026</p>
      <p>This tool is for informational purposes only and does not replace professional medical advice. Contact: <a href="mailto:oljoer@ous-hf.no">oljoer@ous-hf.no</a></p>
    </footer>
  </div>

  <script>
    // ---------- i18n strings ----------
    // English question wording matches the original article Table 1.
    const I18N = {
      en: {
        title: 'Epistaxis Grading (IFT)',
        subtitle: 'IFT measures the severity of nosebleeds in hereditary hemorrhagic telangiectasia (HHT) over the past four weeks. Results may help guide treatment and follow-up.',
        hint: 'Please answer each question. The score uses the two most frequent bleeding intensities, plus the transfusion item.',
        formTitle: 'Over the past 4 weeks',
        q: [
          '1. Over the past 4 weeks, how many times did you notice blood spotting from the nose or drip a few drops of blood from the nose?',
          '2. Over the past 4 weeks, how many times did you have a blood-soaked handkerchief?',
          '3. Over the past 4 weeks, how many times did you have a blood-soaked towel?',
          '4. Over the past 4 weeks, how many times did you have bleeding that amounted to as much as a bowl (0.5 L) of blood?'
        ],
        freq: ['None','1–5 times','6–10 times','11–27 times','Daily or more often'],
        q5: 'Over the past 4 weeks, how many times did you receive a blood transfusion?',
        tNone: 'None', tOnce: 'Once', tMoreThanOnce: 'More than once',
        calc:'Calculate the score', reset:'Reset',
        details:'Show details',
        classes:['No bleeding','Mild bleeding','Moderate bleeding','Severe bleeding','Intractable bleeding'],
        scoreText:(s,max)=>`Your score: ${s}/${max}`,
        err:'Please answer at least one of the first four questions.',
        footerNote:'Translations are provided for accessibility. The IFT has not yet been formally validated in all available languages. If discrepancies arise, the English version prevails.'
      },

      no: {
        title: 'Epistaxis-gradering (IFT)',
        subtitle: 'IFT måler alvorlighetsgrad av neseblødning ved HHT (Mb. Osler) de siste fire ukene. Resultatene kan veilede behandling og oppfølging.',
        hint: 'Svar på hvert punkt. Skåren bruker de to hyppigst forekommende blødningsintensitetene pluss transfusjon.',
        formTitle: 'De siste 4 ukene',
        q: [
          '1. I løpet av de siste 4 ukene, hvor mange ganger fikk du blodflekker fra nesen eller dryppet noen få dråper blod fra nesen?',
          '2. I løpet av de siste 4 ukene, hvor mange ganger fikk du et gjennomtrukket lommetørkle?',
          '3. I løpet av de siste 4 ukene, hvor mange ganger fikk du et gjennomtrukket håndkle?',
          '4. I løpet av de siste 4 ukene, hvor mange ganger fikk du en blødning som fyller så mye som en bolle (1/2 liter) med blod?'
        ],
        freq: ['Ingen','1–5 ganger','6–10 ganger','11 til 27 ganger','Daglig eller mer'],
        q5: 'I løpet av de siste 4 ukene, hvor mange ganger fikk du blodoverføring?',
        tNone:'Ingen', tOnce:'Én gang', tMoreThanOnce:'Flere ganger',
        calc:'Beregn skår', reset:'Nullstill',
        details:'Vis detaljer',
        classes:['Ingen blødning','Mild blødning','Moderat blødning','Alvorlig blødning','Ukontrollerbar blødning'],
        scoreText:(s,max)=>`Din skår: ${s}/${max}`,
        err:'Vennligst svar på minst ett av de fire første spørsmålene.',
        footerNote:'Oversettelser tilbys for tilgjengelighet. IFT er ikke formelt validert på alle tilgjengelige språk. Ved eventuelle avvik er den engelske versjonen autoritativ.'
      },

      'zh-CN': {
        title: '鼻出血分级（IFT）',
        subtitle: 'IFT 评估 HHT（奥斯勒病）患者在过去四周内鼻出血的严重程度。结果可用于指导治疗与随访。',
        hint: '请回答每一项。总分由“最常发生的两种出血强度”加上输血项组成。',
        formTitle: '过去 4 周',
        q: [
          '1. 在过去 4 周内，您出现鼻腔血迹或滴出几滴血的次数是多少？',
          '2. 在过去 4 周内，您的手帕被血完全浸透的次数是多少？',
          '3. 在过去 4 周内，您的毛巾被血完全浸透的次数是多少？',
          '4. 在过去 4 周内，出血量大到可装满一只碗（约 0.5 升）的次数是多少？'
        ],
        freq: ['无','1–5 次','6–10 次','11 至 27 次','每天或更多'],
        q5: '在过去 4 周内，您接受输血的次数是多少？',
        tNone:'无', tOnce:'一次', tMoreThanOnce:'多于一次',
        calc:'计算评分', reset:'重置',
        details:'显示详情',
        classes:['无出血','轻度出血','中度出血','重度出血','难治性出血'],
        scoreText:(s,max)=>`您的评分：${s}/${max}`,
        err:'请至少回答前四个问题中的一个。',
        footerNote:'提供翻译以提高可访问性。IFT 尚未在所有可用语言中经过正式验证。如有差异，以英文版本为准。'
      },

      ja: {
        title: '鼻出血重症度評価（IFT）',
        subtitle: 'IFT は、過去 4 週間における HHT（オスラー病）の鼻出血の重症度を評価します。結果は治療とフォローアップの参考になります。',
        hint: '各項目に回答してください。スコアは「最も頻度の高い 2 つの出血強度」と輸血項目から算出されます。',
        formTitle: '過去 4 週間',
        q: [
          '1. 過去 4 週間で、鼻から血の斑点が出た、または数滴の出血があった回数は何回ですか？',
          '2. 過去 4 週間で、ハンカチが血で完全に染み込んだ回数は何回ですか？',
          '3. 過去 4 週間で、タオルが血で完全に染み込んだ回数は何回ですか？',
          '4. 過去 4 週間で、容器（約 0.5 リットル）を満たすほどの出血があった回数は何回ですか？'
        ],
        freq: ['なし','1～5 回','6～10 回','11～27 回','毎日またはそれ以上'],
        q5: '過去 4 週間で、輸血を受けた回数は何回ですか？',
        tNone:'なし', tOnce:'1 回', tMoreThanOnce:'複数回',
        calc:'スコアを計算', reset:'リセット',
        details:'詳細を表示',
        classes:['出血なし','軽度の出血','中等度の出血','重度の出血','難治性出血'],
        scoreText:(s,max)=>`あなたのスコア：${s}/${max}`,
        err:'最初の 4 問のうち少なくとも 1 問に回答してください。',
        footerNote:'翻訳はアクセシビリティ向上のために提供されています。IFT はすべての言語で正式に検証されているわけではありません。不一致がある場合は英語版が基準となります。'
      },

      es: {
        title: 'Clasificación de epistaxis (IFT)',
        subtitle: 'IFT mide la gravedad de las hemorragias nasales en HHT (enfermedad de Osler) durante las últimas cuatro semanas. Los resultados pueden orientar el tratamiento y el seguimiento.',
        hint: 'Responda cada ítem. La puntuación utiliza las dos intensidades de sangrado más frecuentes más la transfusión.',
        formTitle: 'Durante las últimas 4 semanas',
        q: [
          '1. Durante las últimas 4 semanas, ¿cuántas veces tuvo manchas de sangre en la nariz o goteó unas pocas gotas de sangre por la nariz?',
          '2. Durante las últimas 4 semanas, ¿cuántas veces tuvo un pañuelo empapado de sangre?',
          '3. Durante las últimas 4 semanas, ¿cuántas veces tuvo una toalla empapada de sangre?',
          '4. Durante las últimas 4 semanas, ¿cuántas veces tuvo un sangrado que llenó tanto como un cuenco (0,5 litros) de sangre?'
        ],
        freq: ['Ninguna','1–5 veces','6–10 veces','11 a 27 veces','A diario o más'],
        q5: 'Durante las últimas 4 semanas, ¿cuántas veces recibió una transfusión de sangre?',
        tNone:'Ninguna', tOnce:'Una vez', tMoreThanOnce:'Más de una vez',
        calc:'Calcular puntuación', reset:'Restablecer',
        details:'Mostrar detalles',
        classes:['Sin sangrado','Sangrado leve','Sangrado moderado','Sangrado grave','Sangrado intratable'],
        scoreText:(s,max)=>`Su puntuación: ${s}/${max}`,
        err:'Responda al menos una de las primeras cuatro preguntas.',
        footerNote:'Las traducciones se proporcionan para mejorar la accesibilidad. El IFT no ha sido validado formalmente en todos los idiomas disponibles. En caso de discrepancias, la versión en inglés es la referencia.'
      },

      fr: {
        title: 'Classification des épistaxis (IFT)',
        subtitle: 'L’IFT mesure la sévérité des saignements de nez dans la HHT (maladie d’Osler) au cours des quatre dernières semaines. Les résultats peuvent aider à guider le traitement et le suivi.',
        hint: 'Veuillez répondre à chaque item. Le score utilise les deux intensités de saignement les plus fréquentes plus la transfusion.',
        formTitle: 'Au cours des 4 dernières semaines',
        q: [
          '1. Au cours des 4 dernières semaines, combien de fois avez-vous eu des taches de sang au niveau du nez ou quelques gouttes de sang ont-elles coulé du nez ?',
          '2. Au cours des 4 dernières semaines, combien de fois avez-vous eu un mouchoir imbibé de sang ?',
          '3. Au cours des 4 dernières semaines, combien de fois avez-vous eu une serviette imbibée de sang ?',
          '4. Au cours des 4 dernières semaines, combien de fois avez-vous eu un saignement remplissant autant qu’un bol (0,5 litre) de sang ?'
        ],
        freq: ['Aucune','1–5 fois','6–10 fois','11 à 27 fois','Tous les jours ou plus'],
        q5: 'Au cours des 4 dernières semaines, combien de fois avez-vous reçu une transfusion sanguine ?',
        tNone:'Aucune', tOnce:'Une fois', tMoreThanOnce:'Plus d’une fois',
        calc:'Calculer le score', reset:'Réinitialiser',
        details:'Afficher les détails',
        classes:['Aucun saignement','Saignement léger','Saignement modéré','Saignement sévère','Saignement incontrôlable'],
        scoreText:(s,max)=>`Votre score : ${s}/${max}`,
        err:'Veuillez répondre à au moins une des quatre premières questions.',
        footerNote:'Les traductions sont fournies à des fins d’accessibilité. L’IFT n’a pas encore été validé formellement dans toutes les langues disponibles. En cas de divergence, la version anglaise fait autorité.'
      },

      it: {
        title: 'Classificazione dell’epistassi (IFT)',
        subtitle: 'L’IFT misura la gravità dell’epistassi nella HHT (malattia di Osler) nelle ultime quattro settimane. I risultati possono guidare trattamento e follow-up.',
        hint: 'Rispondere a ogni voce. Il punteggio utilizza le due intensità di sanguinamento più frequenti più la trasfusione.',
        formTitle: 'Durante le ultime 4 settimane',
        q: [
          '1. Durante le ultime 4 settimane, quante volte ha avuto macchie di sangue dal naso o sono gocciolate alcune gocce di sangue dal naso?',
          '2. Durante le ultime 4 settimane, quante volte ha avuto un fazzoletto intriso di sangue?',
          '3. Durante le ultime 4 settimane, quante volte ha avuto un asciugamano intriso di sangue?',
          '4. Durante le ultime 4 settimane, quante volte ha avuto un sanguinamento che riempiva quanto una ciotola (0,5 litri) di sangue?'
        ],
        freq: ['Nessuna','1–5 volte','6–10 volte','11 a 27 volte','Ogni giorno o più'],
        q5: 'Durante le ultime 4 settimane, quante volte ha ricevuto una trasfusione di sangue?',
        tNone:'Nessuna', tOnce:'Una volta', tMoreThanOnce:'Più di una volta',
        calc:'Calcola punteggio', reset:'Reimposta',
        details:'Mostra dettagli',
        classes:['Nessun sanguinamento','Sanguinamento lieve','Sanguinamento moderato','Sanguinamento grave','Sanguinamento intrattabile'],
        scoreText:(s,max)=>`Il tuo punteggio: ${s}/${max}`,
        err:'Rispondere ad almeno una delle prime quattro domande.',
        footerNote:'Le traduzioni sono fornite per migliorare l’accessibilità. L’IFT non è stato formalmente validato in tutte le lingue disponibili. In caso di discrepanze, la versione inglese è quella di riferimento.'
      }
    };

    // ---------- Build questions ----------
    const questionsRoot = document.getElementById('questions');
    const qtpl = document.getElementById('q-template');
    const INTENSITY_WEIGHTS = [1,2,3,4];
    const FREQ_VALUES = [0,1,2,3,4]; // none..daily
    const MAX_TRANSFUSION = 2;

    function buildQuestions(current='en'){
      questionsRoot.innerHTML = '';
      I18N[current].q.forEach((label, idx)=>{
        const node = qtpl.content.cloneNode(true);
        const legend = node.querySelector('legend');
        const opts = node.querySelector('.options');
        const qname = `intensity${idx+1}`;
        legend.textContent = label;

        FREQ_VALUES.forEach((val,i)=>{
          const id = `${qname}-${val}`;
          const wrap = document.createElement('label');
          wrap.className = 'radio';
          wrap.innerHTML = `<input type="radio" name="${qname}" id="${id}" value="${val}"> <span>${I18N[current].freq[i]}</span>`;
          opts.appendChild(wrap);
        });

        questionsRoot.appendChild(node);
      });
    }

    // ---------- Language handling ----------
    const langSelect = document.getElementById('lang-select');

    // Option B with "English on first-ever visit":
    // - if no saved language exists, start with English
    // - otherwise restore last selected language
    let lang = (function(){
      const saved = localStorage.getItem('ift-lang');
      return (saved && I18N[saved]) ? saved : 'en';
    })();

    function applyLang(){
      document.documentElement.lang = lang;

      // Simple keys
      for (const key of ['title','subtitle','hint','formTitle','q5','calc','reset','details','tNone','tOnce','tMoreThanOnce']){
        const nodes = document.querySelectorAll(`[data-i18n="${key}"]`);
        nodes.forEach(n=>{ n.textContent = I18N[lang][key]; });
      }

      // Footer disclaimer (activated)
      document.getElementById('footer-note').textContent = I18N[lang].footerNote;

      document.title = I18N[lang].title;
    }

    function setLang(next){
      if(!I18N[next]) next = 'en';
      lang = next;

      // Persist language for next visit
      try { localStorage.setItem('ift-lang', lang); } catch (e) {}

      langSelect.value = lang;

      buildQuestions(lang);
      applyLang();
      restoreFromStorage();
      bindActions();
    }

    langSelect.addEventListener('change', ()=>{
      setLang(langSelect.value);
    });

    // ---------- Scoring ----------
    function classify(score){
      if(score===0) return 0; // No bleeding
      if(score>=1 && score<=5) return 1;
      if(score>=6 && score<=10) return 2;
      if(score>=11 && score<=15) return 3;
      return 4; // >=16
    }

    function computeScore(frm){
      const answers = INTENSITY_WEIGHTS.map((w,i)=>{
        const rv = frm[`intensity${i+1}`]?.value; // '0'..'4' or undefined
        const freq = rv==null || rv==='' ? null : Number(rv);
        return { weight:w, freq, score: freq===null ? 0 : w*freq };
      });

      const tRaw = frm.transfusion?.value;
      const transfusion = tRaw==null || tRaw==='' ? 0 : Number(tRaw);

      const answeredAny = answers.some(a=>a.freq!==null);
      if(!answeredAny){ return { error: I18N[lang].err }; }

      // Key change: use TWO MOST FREQUENT bleeding intensities.
      // - consider only intensities with freq > 0 (i.e., actual bleeding)
      // - sort by freq desc, tie-break by intensity (weight) desc
      const topTwo = answers
        .filter(a => a.freq !== null && a.freq > 0)
        .sort((a,b) => (b.freq - a.freq) || (b.weight - a.weight))
        .slice(0,2);

      const base = topTwo.reduce((sum,a)=>sum + a.score, 0);
      const total = base + transfusion;
      const max = INTENSITY_WEIGHTS.slice(-2).reduce((s,w)=>s+w*4,0) + MAX_TRANSFUSION; // 30

      return { total, max, breakdown:{answers, topTwo, transfusion} };
    }

    // ---------- Render result ----------
    const formEl = document.getElementById('ift-form');
    const scoreline = document.getElementById('scoreline');
    const classBadge = document.getElementById('classBadge');
    const scoreText = document.getElementById('scoreText');
    const marker = document.getElementById('marker');
    const scale = document.getElementById('scale');
    const details = document.getElementById('details');
    const explain = document.getElementById('explain');

    function renderResult(res){
      const errBox = document.getElementById('form-errors');
      if(res.error){ errBox.textContent = res.error; return; }
      errBox.textContent = '';

      const idx = classify(res.total);
      const labels = I18N[lang].classes;
      const classNames = ['mild','mild','moderate','severe','intractable'];

      classBadge.className = `badge ${classNames[idx]}`;
      classBadge.textContent = labels[idx];

      scoreText.textContent = (I18N[lang].scoreText)(res.total, res.max);
      scoreline.hidden = false;

      const pct = (res.total / res.max) * 100;
      marker.style.left = `${pct}%`;
      scale.hidden = false;

      const list = document.createElement('ul');
      list.style.margin = '8px 0 0';
      list.style.paddingLeft = '18px';

      res.breakdown.topTwo.forEach(t=>{
        const li = document.createElement('li');
        // Use the question text corresponding to intensity (1..4)
        li.textContent = `${I18N[lang].q[t.weight-1].replace(/^\d+\.\s?/,'')} → ${t.weight} × ${t.freq} = ${t.score}`;
        list.appendChild(li);
      });

      const liT = document.createElement('li');
      liT.textContent = `${I18N[lang].q5.replace(/^\d+\.\s?/,'')} → +${res.breakdown.transfusion}`;
      list.appendChild(liT);

      explain.innerHTML='';
      explain.appendChild(list);
      details.hidden = false;

      persistToStorage();
    }

    // ---------- Persistence ----------
    function persistToStorage(){
      const data = new FormData(formEl);
      const obj = {};
      for (const [k,v] of data.entries()) obj[k]=v;
      localStorage.setItem('ift-data', JSON.stringify({ lang, obj }));
    }

    function restoreFromStorage(){
      const raw = localStorage.getItem('ift-data');
      if(!raw) return;
      try{
        const parsed = JSON.parse(raw);
        const obj = parsed?.obj;
        if(!obj || Object.keys(obj).length === 0) return;

        for(const [k,v] of Object.entries(obj)){
          const input = formEl.querySelector(`[name="${k}"][value="${v}"]`);
          if(input) input.checked = true;
        }
      }catch{}
    }

    // ---------- Actions ----------
    function bindActions(){
      const resetBtn = document.getElementById('btn-reset');
      if(resetBtn){
        resetBtn.onclick = ()=>{
          if (typeof formEl.reset !== 'function') console.warn('form.reset unexpected');
          formEl.reset();
          localStorage.removeItem('ift-data');
          buildQuestions(lang);
          applyLang();
          bindActions();
          scoreline.hidden = true; scale.hidden = true; details.hidden = true;
          document.getElementById('form-errors').textContent = '';
        };
      }
    }

    // ---------- Form submit wiring ----------
    formEl.addEventListener('submit', (e)=>{
      e.preventDefault();
      const res = computeScore(formEl);
      renderResult(res);
    });

    // ---------- Init ----------
    // First-visit-per-session: ensure the form starts BLANK once per browser session
    try {
      if (!sessionStorage.getItem('ift-session-init')) {
        localStorage.removeItem('ift-data'); // clear old answers so nothing is prefilled
        sessionStorage.setItem('ift-session-init', '1');
      }
    } catch (e) { /* ignore storage errors */ }

    setLang(lang);
  </script>
</body>
</html>
